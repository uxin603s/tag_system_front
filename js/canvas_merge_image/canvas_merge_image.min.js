function init_canvas(a,n){var w=document.createElement("canvas");w.width=a;w.height=n;return w.getContext("2d")};function dataURItoBlob(a){var n=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var w=new ArrayBuffer(n.length),w=new DataView(w),t=0;t<n.length;t++){var p=n.charCodeAt(t);w.setUint8(t,p)}return new Blob([w],{type:a})};function merge_image(a,n,w,t,p){var f={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};f.set("\u5168\u90e8");try{var u=[];n=JSON.parse(JSON.stringify(n));isNaN(n[0].zIndex)||n.sort(function(a,b){return a.zIndex-b.zIndex});var k=function(a,b,c){if(1==a.type){f.set("\u5716\u5c64"+b+"\u6587\u5b57\u5408\u6210");var d=merge_text(a,b,u);f.set("\u5716\u5c64"+b+"\u6587\u5b57\u5408\u6210");b=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
b;a.y-=b;var g=a.w+2*b,x=a.h+2*b,h=init_canvas(g,x);if(a.bgBorderRadius){var q=2*a.bgBorderRadius;h.lineJoin="round";h.lineWidth=q;h.strokeStyle=a.bgColor;h.strokeRect(q/2,q/2,g-q,x-q)}else q=0;h.fillStyle=a.bgColor;h.fillRect(q/2,q/2,g-q,x-q);h.drawImage(d,b,b,a.w,a.h);a.w=g;a.h=x;d=h.canvas}c&&c(d)}else if(2==a.type)d=new Image,f.set("\u5716\u5c64"+b+"\u5716\u7247\u8b80\u53d6"),d.onload=function(a,b){f.set("\u5716\u5c64"+b+"\u5716\u7247\u8b80\u53d6");c&&c(a)}.bind(this,d,b),d.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},v={finish_count:0},r;for(r in n){var l=n[r];k(l,r,function(e,b,c){e.image_object=c;b.finish_count++;if(n.length<=b.finish_count){e=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),b=(b=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(e.fillStyle="#ffffff",e.fillRect(0,0,a.w,a.h));for(var d in n)if(b=n[d],b.image_object){c=b;if(c.rotate){var g=Math.sqrt(c.w*c.w+c.h*c.h),x=(g-c.w)/2,h=(g-c.h)/2,q=init_canvas(g,g);q.translate(g/2,g/2);q.rotate(c.rotate*Math.PI/180);q.translate(-g/
2,-g/2);q.drawImage(c.image_object,x,h);c.image_object=q.canvas;c.x-=x;c.y-=h;c.w=g;c.h=g}e.drawImage(b.image_object,b.x,b.y,b.w,b.h)}w&&w(e.canvas.toDataURL(a.format,a.compress));f.set("\u5168\u90e8");e=f.get();for(d in e)e[d]=(e[d][1]-e[d][0])/1E3;t&&t(e,u)}}.bind(this,l,v))}}catch(e){p&&p(e)}return this};function merge_text(a){function n(a){for(var b in a)"object"==typeof a[b]?a[b]=n(a[b]):isNaN(a[b])||""==a[b]||(a[b]*=1);return a}function w(a,b,c,h,q){h.index=0;var g=[];if(-1!=a.text_content.indexOf("\n")){var e=a.text_content.split("\n"),d;for(d in e){var m=e[d],f=b.measureText(m).width;g.push({text:m,w:f})}return g}q||(q=0);var k=a.text_content,l=0;if(-1==h.source.indexOf(" ")){if(!c)if(c=0,h.list.length)for(d in h.list)m=h.list[d].text,m=b.measureText(m).width,m>c&&(c=m);else c=a.w;var n=Math.floor(c/
a.text_size*1.5);n||(n=1);var l=1,p=n}else{var l=2,v=b.measureText(" ").width,r=[],k=h.source.replace(/###user_name###/g,"").split(" ");c||(c=0);for(d in k)m=k[d].replace(/###space###/g," "),m=b.measureText(m).width,r.push(m),m>c&&(c=m)}for(var x=0;;){if(1==l)for(d in m=k.substr(0,p),h.index+=m.length,h.list){var e=h.list[d].start,u=h.list[d].end;if(e<=h.index&&h.index<u){h.index-=m.length;var t=e-h.index;0==t&&(t=u-e);m=k.substr(0,t);h.index+=m.length}}else{u=r.length;do if(e=r.slice(0,u),f=e.reduce(function(a,
b){var c=0;0!=a&&(c+=v);return c+(a+b)},0),f>c)u--;else break;while(1);m=k.splice(0,u).join(" ").replace(/###space###/g," ");f=b.measureText(m).width;r.splice(0,u)}if(1==l)if(f=b.measureText(m).width,1!=p&&f>c)h.index-=m.length,p--;else{if(x=0,e=m.length,t=k.length-m.length,k=k.substr(e,t),m&&g.push({text:m,w:f}),p=n,!k.length){if(!h.list.length&&(t=g.length,1!=t&&g[t-2].w/2>g[t-1].w)){g=[];c*=1.1;n=Math.floor(c/a.text_size*1.5);k=a.text_content;continue}break}}else if(m&&g.push({text:m,w:f}),!k.length)break;
if(1E3<++x)throw console.log(h.source,g,x,p),"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";}k=1.2*a.text_size;a.useFontBg&&a.FontBgSize&&(k+=a.FontBgSize);l=f=0;for(d in g)l?g[d].w<l&&(l=g[d].w):l=g[d].w,g[d].w>f&&(f=g[d].w);d=k*g.length;f=f*a.h/a.w;if(1!=g.length&&f<d){c*=1.1;if(100<q)throw console.log("error",h.source,c,a.text_size,f,d),"\u5361\u8ff4\u5708";return w(a,b,c,h,++q)}return g}function t(a,b,c,e){var d=init_canvas(c,e);d.fillStyle=b.text_color;d.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";
d.textBaseline="middle";b.useFontBg&&b.FontBgSize&&(d.lineWidth=b.FontBgSize,d.strokeStyle=b.FontBgColor);var f=0,g=b.text_size/2;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize);b.useFontBg&&b.FontBgSize&&d.strokeText(a,f,g);d.fillText(a,f,g);b.useLine&&(a=1==b.useLine?.9:.5,d.strokeStyle=b.text_color,d.lineWidth=Math.floor(b.text_size/10),g=e*a-d.lineWidth/2,d.moveTo(0,g),d.lineTo(c,g),d.stroke());return d.canvas}a=JSON.parse(JSON.stringify(a));var p=init_canvas(a.w,a.h);if(!a.text_content||isNaN(a.w)||
isNaN(a.h)||0==a.w||0==a.h||20>a.w||20>a.h)return p.canvas;a.w=Math.abs(a.w);a.h=Math.abs(a.h);a=n(a);a.text_content=a.text_content.toString().trim();a.text_size>a.h&&(a.text_size=a.h);var f=a.text_content.match(/###user_name###([\w\W]+?)###user_name###/g),u={source:a.text_content,list:[],index:0};if(f){for(var k in f){var v=a.text_content.indexOf(f[k]),r=f[k].length,l=a.text_content.split(""),e=l.slice(v,v+r).join(""),b=e.replace(/###user_name###/g,"").replace(/###space###/g," ");l.splice(v,r,b);
a.text_content=l.join("");u.list.push({text:b,source:e,start:v,count:b.length,end:v+b.length})}u.list.reverse()}(function(a){var b=a.text_content.length,c=a.text_size;a.useFontBg&&a.FontBgSize&&(c+=2*a.FontBgSize);a.text_size=Math.floor(a.text_size*Math.sqrt(a.w*a.h/(b*c*c*1.44)))})(a);p.fillStyle=a.text_color;p.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";p.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(p.lineWidth=a.FontBgSize,p.strokeStyle=a.FontBgColor);20>a.text_size&&(a.text_size=
20,p.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4");0!=a.text_type||a.text_content.match(/[^a-zA-Z0-9\.]+/)||(a.text_type=1);if(0==a.text_type)var c=w(a,p,void 0,u);else if(1==a.text_type)a.text_content=a.text_content.replace(/###user_name###/g,"").replace(/###space###/g," "),b=a.text_content,f=Math.ceil(p.measureText(b).width),c=[{text:b,w:f}];else if(2==a.text_type){a.text_content=a.text_content.replace(/###user_name###/g,"").replace(/###space###/g," ");l=a.text_content.split("");c=[];for(k in l)b=
l[k],f=Math.ceil(p.measureText(b).width),c.push({text:b,w:f});console.log(c)}e=1.2*a.text_size;b=0;for(k in c)c[k].w>b&&(b=c[k].w);b=Math.ceil(b);e=Math.ceil(e);a.useFontBg&&a.FontBgSize&&(b+=2*a.FontBgSize,e+=a.FontBgSize);l=b;f=e*c.length;u=[];for(k in c)r=c[k],b=r.text,v=r.w,a.useFontBg&&a.FontBgSize&&(v+=2*a.FontBgSize),v=Math.ceil(v),b=t(b,a,v,e),u.push(b);c=init_canvas(l,f);e=b=0;for(k in u)r=u[k],v=r.width,r=r.height,0==a.text_hAlign?b=0:1==a.text_hAlign?b=(l-v)/2:2==a.text_hAlign&&(b=l-v),
c.drawImage(u[k],b,e,v,r),e+=r;k=a.w/l;l*=k;f*=k;f>a.h&&(k=a.h/f,l*=k,f*=k);e=b=0;0==a.text_hAlign?b=0:1==a.text_hAlign?b=(a.w-l)/2:2==a.text_hAlign&&(b=a.w-l);0==a.text_vAlign?e=0:1==a.text_vAlign?e=(a.h-f)/2:2==a.text_vAlign&&(e=a.h-f);p.drawImage(c.canvas,b,e,l,f);return p.canvas};

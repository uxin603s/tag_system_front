<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8" />
	<script src="js/jquery-1.12.4.min.js?t=<?=time()?>"></script>
	<script src="js/angular-1.5.8.min.js?t=<?=time()?>"></script>
	<script src="js/localForage-1.4.2.min.js?t=<?=time()?>"></script>
	<script src="app/modules/cache/cache.js?t=<?=time()?>"></script>
	<script>
	angular.module("app",["cache"]).controller("whxyDemoCtrl",["$scope",function($scope){
		
		// $scope.$watch("cache.whxy_arr",function(whxy_arr){
			// console.log(whxy_arr)
		// },1)
		
		$scope.$watch("cache",function(cache){
			if(cache.not_finish_flag)return;
			// delete $scope.cache.whxy_arr
			$scope.cache.whxy_arr || ($scope.cache.whxy_arr=[
				{x:0,y:0,w:100,h:100,image_src:"http://ipetair.com/wp-content/uploads/2014/09/479_%E7%8B%97%E7%8B%97%E7%9A%84%E8%BA%AB%E9%AB%94%E8%AA%9E%E8%A8%80%E4%BD%A0%E7%9F%A5%E5%A4%9A%E5%B0%91_1.jpg"},
				{x:50,y:50,w:100,h:100,image_src:"http://static.mindcity.sina.com.tw/MC_data/focus/fate/008/images/area111/14159593911621.jpg"},
			])
			
			// console.log(cache)
			
		},1)
		$scope.backWH=function(item,type){
			var img=new Image
			img.onload=function(){
				if(type){
					var d=this.naturalWidth/this.naturalHeight;
					// w:h=ww:hh
					// console.log(d)
					if(item.w>item.h){
						item.h=Math.ceil(item.w/d);
					}else{
						item.h=Math.ceil(item.w/d);
					}
				}else{
					item.w=this.naturalWidth
					item.h=this.naturalHeight
				}
				$scope.$apply();
			}
			img.src=item.image_src
		}
		// $scope.lock_arr={};
		// $scope.lock=function(index,type){
			// if(type){
				// $scope.lock_arr[index]=$scope.$watch(function(){
					// return $scope.cache.whxy_arr[index];
				// },function(data){
					// console.log(data,"lock")
				// },1)
			// }else{
				// $scope.lock_arr[index]()
			// }
			
		// }
		$scope.cache.hide || ($scope.cache.hide={});
		$scope.cache.scale || ($scope.cache.scale={});
	}])
	</script>
	<script src="app/components/whxy/whxy.js"></script>
	<script src="app/directives/sortable/sortable.js"></script>
	<link rel="stylesheet" type="text/css" href="css/bootstrap-3.3.7.min.css" />
	<link rel="stylesheet" type="text/css" href="css/index.css" />
</head>
<body 
ng-app="app"
ng-controller="whxyDemoCtrl"
style="overflow-y: scroll;"
>

	<div
	ng-repeat="item in cache.whxy_arr"
	>
		<button 
		draggable="true"
		sortable="cache.whxy_arr"
		index="$index"
		>{{$index}}</button>
		<input type="text" ng-model="item.x" />
		<input type="text" ng-model="item.y" />
		<input type="text" ng-model="item.w" />
		<input type="text" ng-model="item.h" />
		<img style="height:50px;" ng-src="{{item.image_src}}" />
		<button ng-click="backWH(item,0)">還原大小</button>
		<button ng-click="backWH(item,1)">還原比例</button>
		
		<button 
		ng-click="cache.scale[$index]=!cache.scale[$index]"
		ng-class="cache.scale[$index]?'btn-danger':'btn-primary'"
		
		class="btn btn-sm"
		>鎖比例</button>
		<button 
		ng-click="cache.hide[$index]=!cache.hide[$index]"
		ng-class="cache.hide[$index]?'btn-danger':'btn-primary'"
		class="btn btn-sm" 
		>隱藏</button>
		
	</div>
	<div 
	draggable="false"
	style="
	position:relative;overflow:hidden;
	width:1200px;
	height:630px;
	" 
	>
	
		<whxy
		hide="cache.hide[$index]"
		scale="cache.scale[$index]"
		ng-repeat="item in cache.whxy_arr"
		
		data="item"
		>
			<img 
			style="
			width:100%;
			height:100%;
			"
			
			ng-src="{{item.image_src}}" />
		</whxy>
	</div>
</body>
</html>
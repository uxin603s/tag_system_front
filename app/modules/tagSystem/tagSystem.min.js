angular.module("tagSystem",[]).component("tagSystem",{bindings:{url:"=",accessToken:"=",wid:"="},templateUrl:"app/modules/tagSystem/tagSystem.html?t="+Date.now(),controller:["$scope","tagSystem",function(a,b){a.$ctrl.$onInit=function(){a.$watch("$ctrl.wid",function(i){b.data.wid=i},1);a.tagSystem=b.data;a.control=b.data.control;var e=location.search.match(/\?([\d\D]+)/);var h=RegExp.$1.split("&");var c={};for(var g in h){var f=h[g].split("=");c[f[0]]=f[1]}if(c.search){b.searchTid(c.search,function(i){b.addSearchTid(i,1)})}var d=a.$ctrl.url;if(a.$ctrl.accessToken){var j=a.$ctrl.accessToken;d+="?access_token="+j}b.init(d);$("tag-system>div").append(b.iframe);b.data.wid=a.$ctrl.wid};a.getTag=function(f){if(a.control.mode==1){var d=a.control.edit.list;var h=a.control.edit.id;var e={tid:f,source_id:h};b.addTag(e,d)}else{if([2,3].indexOf(a.control.mode)){var c=a.control.search.data.optional.indexOf(f);var i=a.control.search.data.tmp.indexOf(f);var g=a.control.search.data.required.indexOf(f);if(c==-1&&i==-1&&g==-1){a.control.search.data.optional.push(f)}}}}}]});angular.module("tagSystem").component("tagRelation",{bindings:{selects:"=",index:"=",lids:"=",show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagRelation/tagRelation.html?t="+Date.now(),controller:["$scope","tagSystem","tagLevel",function(b,d,a){b.tagName=d.data.tagName;b.delTag=function(e){if(!confirm("確認刪除?")){return}var j=b.id;var i=b.list.splice(e,1).pop();var h=b.lid;var f=a.data.TagLevelRelation[b.$ctrl.lids[b.$ctrl.index+1]];if(f&&f[i]&&f[i].length){alert("下層有資料無法刪除");b.list.splice(e,0,i);return}var g={func_name:"TagRelation::delete",arg:{child_id:i,id:j,level_id:h}};d.post(g,function(k){console.log(k);if(!k.status){}})};b.addTag=function(h){if(!h){alert("請勿空白");return}var h=h;var i=b.id;var e=b.list?b.list.length:0;var g=b.lid;var f={func_name:"TagRelation::insert",arg:{id:i,sort_id:e,level_id:g,tag_name:h}};d.post(f,function(j){console.log(j);if(j.status){b.list.push(j.insert.child_id);d.data.tagName[j.insert.child_id]=h}else{alert("資料重複")}})};b.$ctrl.$onInit=function(){b.tagSystem=d.data;var e;b.$watch("$ctrl.selects["+b.$ctrl.index+"]",function(f){e&&e();if(!isNaN(f)){b.id=f;b.lid=b.$ctrl.lids[b.$ctrl.index];if(!a.data.TagLevelRelation[b.lid][f]){a.data.TagLevelRelation[b.lid][f]=[]}b.list=a.data.TagLevelRelation[b.lid][f];e=b.$watch("list",c.bind(this,b.lid,f),1);b.show=true}else{b.list=[];b.show=false}},1)};var c=function(j,k,e,g){if(e.length==g.length){for(var f in e){if(e[f]!=g[f]){var h={func_name:"TagRelation::update",arg:{update:{sort_id:f},where:{level_id:j,id:k,child_id:e[f]}}};d.post(h,function(i){console.log(i)})}}}}}]});angular.module("tagSystem").component("insertTagElement",{bindings:{id:"=",list:"="},templateUrl:"app/modules/tagSystem/components/insertTagElement/insertTagElement.html?t="+Date.now(),controller:["$scope","tagSystem",function(a,b){a.tagName=b.data.tagName;a.delTag=b.delTag;a.addTag=b.addTag}]});angular.module("tagSystem").component("searchTag",{bindings:{data:"="},templateUrl:"app/modules/tagSystem/components/searchTag/searchTag.html?t="+Date.now(),controller:["$scope","tagSystem","$timeout",function(a,b,c){a.$ctrl.$onInit=function(){a.control=b.data.control;b.data.control.search.data=a.$ctrl.data};a.searchTag=function(){b.data.control.mode=2};a.getTag=function(d){b.addSearchTid(d,0)}}]});angular.module("tagSystem").component("tagLevel",{bindings:{tid:"=",show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagLevel/tagLevel.html?t="+Date.now(),controller:["$scope","tagSystem","tagLevel","tagType","tagRelation",function(b,c,a,d,e){b.add=function(){if(!confirm("確認新增階層?")){return}var f={func_name:"TagLevel::insert",arg:{sort_id:b.list.length,tid:b.$ctrl.tid}};c.post(f,function(g){if(g.status){b.list.push(g.insert.id);a.data.TagLevelRelation[g.insert.id]={};if(b.list.length==1){b.selects[0]=0}}})};b.del=function(f){if(!confirm("確認刪除階層?")){return}var l=b.list.splice(f,1).pop();var j=b.$ctrl.tid;var h=0;for(var g in a.data.TagLevelRelation[l]){h+=a.data.TagLevelRelation[l][g].length}if(h){alert("該階層有標籤無法刪除!!!");b.list.splice(f,0,l);return}var k={func_name:"TagLevel::delete",arg:{id:l,tid:b.$ctrl.tid}};c.post(k,function(i){console.log(i);if(i.status){delete a.data.TagLevelRelation[i.where.id]}else{b.list.splice(f,0,l)}})};b.$ctrl.$onInit=function(){b.tagSystem=c.data;b.tagLevel=a.data;b.tagRelation=a.data;b.$watch("tagLevel.selects["+b.$ctrl.tid+"]",function(f){b.selects=f},1);b.$watch("tagLevel.tagTypeLevel["+b.$ctrl.tid+"]",function(f){b.list=f},1);b.primary_data=d.data.primary_data}}]});angular.module("tagSystem").component("sourceTag",{bindings:{id:"=",name:"="},templateUrl:"app/modules/tagSystem/components/sourceTag/sourceTag.html?t="+Date.now(),controller:["$scope","tagSystem",function(b,d){b.sourceIdRelationTag=d.data.sourceIdRelationTag;var e=function(f){f.wid=d.data.wid;var g={func_name:"WebRelation::update",arg:f};d.post(g,function(h){console.log(h)})};var a;var c=function(f){return new Promise(function(h,g){var i=[];i.push({field:"wid",type:0,value:d.data.wid});i.push({field:"source_id",type:0,value:f});var j={func_name:"WebRelation::getList",arg:{where_list:i}};d.post(j,function(k){var l=[];if(k.status){b.list=k.list.sort(function(n,m){return n.sort_id-m.sort_id}).map(function(m){return m.tid});h(b.list)}else{b.list=[]}b.sourceIdRelationTag[f]=b.list;a&&a();a=b.$watch("list",function(m,o){if(m.length==o.length){for(var n in m){if(m[n]!=o[n]){e({update:{sort_id:n},where:{tid:m[n],source_id:b.$ctrl.id}})}}}},1)})})};b.getTag=function(h){var f=b.list;var i=b.$ctrl.id;var g={tid:h,source_id:i};d.addTag(g,f)};b.$ctrl.$onInit=function(){c(b.$ctrl.id).then(function(f){return d.getTagName(f)})};b.editTag=function(g,f){d.data.control.edit.id=g;d.data.control.edit.name=f;d.data.control.edit.list=b.sourceIdRelationTag[g];d.data.control.mode=1}}]});angular.module("tagSystem").component("tagType",{bindings:{show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagType/tagType.html?t="+Date.now(),controller:["$scope","$http","tagSystem","tagType",function(a,d,b,c){a.delWebTagType=function(f,g){var e={};e.tid=g.splice(f,1).pop();e.wid=b.data.wid;var h={func_name:"WebTagType::delete",arg:e};b.post(h,function(i){console.log(i)})};a.addWebTagType=function(e,f){if(f.indexOf(e.tid)==-1){f.push(e.tid)}e.wid=b.data.wid;e.sort_id=f.length;var g={func_name:"WebTagType::insert",arg:e};b.post(g,function(h){console.log(h)})};a.$ctrl.$onInit=function(){a.tagSystem=b.data;a.tagType=c.data};a.ch=function(f,e){f.show=!f.show;d.post("ajax.php",{func_name:"TagType::update",arg:{update:f.update,where:f.where}}).success(function(h){if(h.status){for(var g in f.update){e[g]=f.update[g]}}console.log(h)})}}]});angular.module("tagSystem").component("searchTagElement",{bindings:{data:"="},templateUrl:"app/modules/tagSystem/components/searchTagElement/searchTagElement.html?t="+Date.now(),controller:["$scope","tagSystem","$timeout",function(b,c,d){b.$ctrl.$onInit=function(){b.$watch("$ctrl.data",function(){b.$ctrl.data.required||(b.$ctrl.data.required=[]);b.$ctrl.data.optional||(b.$ctrl.data.optional=[]);b.$ctrl.data.tmp||(b.$ctrl.data.tmp=[]);b.$ctrl.data.result||(b.$ctrl.data.result=[]);b.$watch("$ctrl.data.required",e,1);b.$watch("$ctrl.data.optional",e,1)},1)};b.addSearch=function(g){c.searchTid(g,function(h){c.addSearchTid(h,0)})};var f;var e=function(g){d.cancel(f);f=d(function(){c.getTagName(b.$ctrl.data.required);c.getTagName(b.$ctrl.data.optional);c.getTagName(b.$ctrl.data.tmp);var i=angular.copy(b.$ctrl.data.required);var h=angular.copy(b.$ctrl.data.optional);if(i.length+h.length){a(1,h,[],function(j){if(i.length){a(0,i,[],function(k){if(j.length){var m=[];for(var l in k){if(j.indexOf(k[l])!=-1){m.push(k[l])}}b.$ctrl.data.result=m}else{b.$ctrl.data.result=k}})}else{b.$ctrl.data.result=j}})}else{b.$ctrl.data.result=[]}},50)};b.tagName=c.data.tagName;var a=function(h,n,l,o){if(!l){l=[]}var k=n.pop();var j=[];j.push({field:"wid",type:0,value:c.data.wid});j.push({field:"tid",type:0,value:k});for(var g in l){j.push({field:"source_id",type:h,value:l[g]})}var m={func_name:"WebRelation::getList",arg:{where_list:j,group_list:["source_id"]}};c.post(m,function(p){if(p.status){var i=p.list.map(function(q){return q.source_id});if(h==0){l=i}else{if(h==1){l=l.concat(i)}}}else{if(h==0){o([]);return}}if(n.length){a(h,n,l,o)}else{o(l)}})}}]});angular.module("tagSystem").factory("tagLevel",["$rootScope","tagSystem","$timeout","tagType",function(a,b,c,e){var g={tagTypeLevel:{},selects:{},TagLevelRelation:{}};var h=function(n){var l=[];for(var j in n){var k=n[j];if(!g.tagTypeLevel[k]){g.tagTypeLevel[k]=[];g.selects[k]=[];l.push({field:"tid",type:0,value:k})}}if(!l.length){return}var m={func_name:"TagLevel::getList",arg:{where_list:l}};b.post(m,function(p){if(p.status){var r=p.list.sort(function(u,i){return u.sort_id-i.sort_id});for(var o in r){var q=r[o];var s=q.tid;var t=q.id;g.tagTypeLevel[s].push(t)}}})};a.$watch(function(){return e.data.select_arr},function(i){h(i)},1);a.$watch(function(){return g.tagTypeLevel},function(i){var j=[];for(var k in i){j=j.concat(i[k])}if(j.length){f(j)}},1);var f=function(k){var l=[];for(var j in k){var n=k[j];if(!g.TagLevelRelation[n]){g.TagLevelRelation[n]={};l.push({field:"level_id",type:0,value:n})}}if(!l.length){return}var m={func_name:"TagRelation::getList",arg:{where_list:l,order_list:[{field:"sort_id",type:0}]}};b.post(m,function(p){if(p.status){var s=[];for(var o in p.list){var q=p.list[o];var u=q.id;var t=q.child_id;var r=q.level_id;if(!g.TagLevelRelation[r][u]){g.TagLevelRelation[r][u]=[]}g.TagLevelRelation[r][u].push(t);s.push(t)}b.getTagName(s);for(var o in k){d(k[o])}}})};var d=function(o){for(var n in g.tagTypeLevel){var m=g.tagTypeLevel[n];if(m[0]==o){var l,j;for(var k in m){var o=m[k];if(k==0){j=0}else{if(l){j=l[0]}else{continue}}g.selects[n][k]=j;l=g.TagLevelRelation[o][j]}if(l&&l[0]){g.selects[n][k*1+1]=l[0]}break}}};return{data:g}}]);angular.module("tagSystem").factory("tagRelation",["$rootScope","tagSystem","$timeout","tagType","tagLevel",function(a,c,d,e,b){return{}}]);angular.module("tagSystem").factory("tagSystem",["$rootScope",function(k){var f={tagName:{},control:{mode:0,edit:{},search:{data:{}}},sourceIdRelationTag:{},selects:[],tag_mode:0};var e=document.createElement("iframe");e.style="width:100%;height:100%;";e.setAttribute("marginwidth",0);e.setAttribute("marginheight",0);e.setAttribute("scrolling","no");e.setAttribute("frameborder",0);e.setAttribute("style","display:none;");var b;var d={};var g={};var n=function(p){var o=function(){b=e.contentWindow;postMessageHelper.init("tagSystem",b);postMessageHelper.receive("tagSystem",function(q){if(q.name=="post"){g[q.value.id]=q.value.value}k.$apply()})};e.onload=o;e.src=p};var l=function(o,r){var q="rand"+Date.now()+Math.floor(Math.random()*9999);postMessageHelper.send("tagSystem",{name:"post",value:{request:o,id:q}});var p=k.$watch(function(s){return g[s]}.bind(this,q),function(s){if(s){r&&r(s);p()}},1)};var m=function(r){var p=[];for(var o in r){if(!f.tagName[r[o]]){p.push({field:"id",type:0,value:r[o]})}}if(!p.length){return}var q={func_name:"TagName::getList",arg:{where_list:p}};l(q,function(u){if(u.status){for(var t in u.list){var v=u.list[t].id;var s=u.list[t].name;f.tagName[v]=s}}})};var c={};var a=function(o,p){if(o.tid){p.push(o.tid)}else{if(!o.tag_name){alert("請勿空白");return}}if(c[o.source_id]){alert("新增資料中，請稍等...");return}else{c[o.source_id]=true}o.wid=f.wid;o.sort_id=p.length;var q={func_name:"WebRelation::insert",arg:o};l(q,function(r){if(o.tag_name){if(r.status){var s=r.insert.tid;f.tagName[s]=o.tag_name;p.push(s);alert("新增成功")}else{alert("新增失敗")}}delete c[o.source_id]})};var j=function(q,o,t){if(!confirm("確認刪除?")){return}var r=q.splice(o,1).pop();var p=f.wid;var s={func_name:"WebRelation::delete",arg:{source_id:t,wid:p,tid:r}};l(s,function(u){console.log(u);if(!u.status){q.splice(o,0,r)}})};var h=function(s,r){var p=["optional","required","tmp"];for(var q in p){var o=f.control.search.data[p[q]].indexOf(s);if(o==-1){}else{f.control.search.data[p[q]].splice(o,1)}}f.control.search.data[p[r]].push(s)};var i=function(q,r){var o=[];o.push({field:"name",type:0,value:q});var p={func_name:"TagName::getList",arg:{where_list:o}};l(p,function(t){if(t.status){var u=t.list[0].id;var s=t.list[0].name;f.tagName[u]=s;r&&r(u)}else{alert("沒有這個標籤")}})};return{init:n,iframe:e,post:l,data:f,getTagName:m,delTag:j,addTag:a,searchTid:i,addSearchTid:h}}]);angular.module("tagSystem").factory("tagType",["$rootScope","tagSystem","$timeout",function(b,c,d){var f={select_arr:[],not_select_arr:[],primary_data:{}};var a=function(i){f.select_arr.length=0;return new Promise(function(k,j){var l={func_name:"WebTagType::getList",arg:{where_list:[{field:"wid",type:0,value:i}],order_list:[{field:"sort_id",type:0}]}};c.post(l,function(m){if(m.status){m.list.map(function(n){f.select_arr.push(n.tid)})}k()})})};var e=function(){return new Promise(function(j,i){var k=[];var l={func_name:"TagType::getList",arg:{where_list:k}};c.post(l,function(n){if(n.status){for(var m in n.list){var o=n.list[m];var p=o.id;f.primary_data[p]=o}}j()})})};var h;var g=function(){d.cancel(h);h=d(function(){f.not_select_arr.length=0;for(var j in f.primary_data){j*=1;var i=f.select_arr.indexOf(j);if(i==-1){f.not_select_arr.push(j)}}},0)};e().then(function(){b.$watch(function(){return f.primary_data},g,1);b.$watch(function(){return f.select_arr},g,1);b.$watch(function(){return f.select_arr},function(j,l){if(j.length==l.length){for(var k in j){if(j[k]!=l[k]){var m={func_name:"WebTagType::update",arg:{where:{wid:c.data.wid,tid:j[k]},update:{sort_id:k}}};c.post(m,function(i){console.log(i)})}}}},1)});b.$watch(function(){return c.data.wid},function(i){if(i){a(i)}},1);return{data:f,getTagType:e}}]);
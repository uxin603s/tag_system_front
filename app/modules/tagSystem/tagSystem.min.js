angular.module("tagSystem",[]).component("tagSystem",{bindings:{url:"=",accessToken:"=",wid:"="},templateUrl:"app/modules/tagSystem/tagSystem.html?t="+Date.now(),controller:["$scope","tagSystem",function(a,b){a.$ctrl.$onInit=function(){a.tagSystem=b.data;a.control=b.data.control;var e=location.search.match(/\?([\d\D]+)/);var h=RegExp.$1.split("&");var c={};for(var g in h){var f=h[g].split("=");c[f[0]]=f[1]}if(c.search){b.searchTid(c.search,function(i){b.addSearchTid(i,1)})}var d=a.$ctrl.url;if(a.$ctrl.accessToken){var j=a.$ctrl.accessToken;d+="?access_token="+j}b.init(d);$("tag-system>div").append(b.iframe);b.data.wid=a.$ctrl.wid};a.getTag=function(f){if(a.control.mode==1){var d=a.control.edit.list;var h=a.control.edit.id;var e={tid:f,source_id:h};b.addTag(e,d)}else{if(a.control.mode==2){var c=a.control.search.data.optional.indexOf(f);var i=a.control.search.data.tmp.indexOf(f);var g=a.control.search.data.required.indexOf(f);if(c==-1&&i==-1&&g==-1){a.control.search.data.optional.push(f)}}}}}]});angular.module("tagSystem").component("tagRelation",{bindings:{selects:"=",index:"=",lids:"=",show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagRelation/tagRelation.html?t="+Date.now(),controller:["$scope","tagSystem","tagRelation",function(a,b,c){a.tagName=b.data.tagName;a.delTag=function(d){if(!confirm("確認刪除?")){return}var h=a.id;var g=a.list.splice(d,1).pop();var f=a.lid;if(a.check_delete&&a.check_delete[g]&&a.check_delete[g].length){alert("下層有資料無法刪除");a.list.splice(d,0,g);return}var e={func_name:"TagRelation::delete",arg:{child_id:g,id:h,level_id:f}};b.post(e,function(i){console.log(i);if(!i.status){}})};a.addTag=function(g){if(!g){alert("請勿空白");return}var g=g;var h=a.id;var d=a.list?a.list.length:0;var f=a.lid;var e={func_name:"TagRelation::insert",arg:{id:h,sort_id:d,level_id:f,tag_name:g}};b.post(e,function(i){if(i.status){a.list.push(i.insert.child_id);b.data.tagName[i.insert.child_id]=g}else{alert("資料重複")}})};a.$ctrl.$onInit=function(){a.tagSystem=b.data;a.$watch("$ctrl.selects["+a.$ctrl.index+"]",function(d){if(!isNaN(d)){a.show=true;a.id=d;a.lid=a.$ctrl.lids[a.$ctrl.index];a.list=c.data.TagLevelRelation[a.lid][d];a.check_delete=c.data.TagLevelRelation[a.$ctrl.lids[a.$ctrl.index+1]]}else{a.show=false}},1)}}]});angular.module("tagSystem").component("insertTagElement",{bindings:{id:"=",list:"="},templateUrl:"app/modules/tagSystem/components/insertTagElement/insertTagElement.html?t="+Date.now(),controller:["$scope","tagSystem",function(a,b){a.tagName=b.data.tagName;a.delTag=b.delTag;a.addTag=b.addTag}]});angular.module("tagSystem").component("searchTag",{bindings:{data:"="},templateUrl:"app/modules/tagSystem/components/searchTag/searchTag.html?t="+Date.now(),controller:["$scope","tagSystem","$timeout",function(a,b,c){a.$ctrl.$onInit=function(){a.control=b.data.control;b.data.control.search.data=a.$ctrl.data};a.searchTag=function(){b.data.control.mode=2};a.getTag=function(d){b.addSearchTid(d,0)}}]});angular.module("tagSystem").component("tagLevel",{bindings:{tid:"=",show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagLevel/tagLevel.html?t="+Date.now(),controller:["$scope","tagSystem","tagLevel","tagType","tagRelation",function(b,c,a,d,e){b.add=function(){if(!confirm("確認新增階層?")){return}var f={func_name:"TagLevel::insert",arg:{sort_id:b.list.length,tid:b.$ctrl.tid}};c.post(f,function(g){if(g.status){b.list.push(g.insert.id);b.TagLevelRelation[g.insert.id]={}}})};b.del=function(f){if(!confirm("確認刪除階層?")){return}var i=b.list.splice(f,1).pop();var g=b.$ctrl.tid;if(b.TagLevelRelation[i]&&Object.keys(b.TagLevelRelation[i]).length){alert("該階層有標籤無法刪除!!!");b.list.splice(f,0,i);return}var h={func_name:"TagLevel::delete",arg:{id:i,tid:b.$ctrl.tid}};c.post(h,function(j){console.log(j);delete b.TagLevelRelation[j.where.id]})};b.$ctrl.$onInit=function(){b.tagSystem=c.data;b.tagLevel=a.data;b.tagRelation=e.data;b.$watch("tagRelation.TagLevelRelation",function(f){b.TagLevelRelation=f},1);b.$watch("tagLevel.selects["+b.$ctrl.tid+"]",function(f){b.selects=f},1);b.$watch("tagLevel.tagTypeLevel["+b.$ctrl.tid+"]",function(f){b.list=f},1);b.primary_data=d.data.primary_data}}]});angular.module("tagSystem").component("sourceTag",{bindings:{id:"=",name:"="},templateUrl:"app/modules/tagSystem/components/sourceTag/sourceTag.html?t="+Date.now(),controller:["$scope","tagSystem",function(b,d){b.sourceIdRelationTag=d.data.sourceIdRelationTag;var e=function(f){f.wid=d.data.wid;var g={func_name:"WebRelation::update",arg:f};d.post(g,function(h){console.log(h)})};var a;var c=function(f){return new Promise(function(h,g){var i=[];i.push({field:"wid",type:0,value:d.data.wid});i.push({field:"source_id",type:0,value:f});var j={func_name:"WebRelation::getList",arg:{where_list:i}};d.post(j,function(k){var l=[];if(k.status){b.list=k.list.sort(function(n,m){return n.sort_id-m.sort_id}).map(function(m){return m.tid});h(b.list)}else{b.list=[]}b.sourceIdRelationTag[f]=b.list;a&&a();a=b.$watch("list",function(m,o){if(m.length==o.length){for(var n in m){if(m[n]!=o[n]){e({update:{sort_id:n},where:{tid:m[n],source_id:b.$ctrl.id}})}}}},1)})})};b.getTag=function(h){var f=b.list;var i=b.$ctrl.id;var g={tid:h,source_id:i};d.addTag(g,f)};b.$ctrl.$onInit=function(){c(b.$ctrl.id).then(function(f){return d.getTagName(f)})};b.editTag=function(g,f){d.data.control.edit.id=g;d.data.control.edit.name=f;d.data.control.edit.list=b.sourceIdRelationTag[g];d.data.control.mode=1}}]});angular.module("tagSystem").component("tagType",{bindings:{show:"=",getTag:"="},templateUrl:"app/modules/tagSystem/components/tagType/tagType.html?t="+Date.now(),controller:["$scope","tagSystem","tagType",function(a,b,c){a.delWebTagType=function(e,f){var d={};d.tid=f.splice(e,1).pop();d.wid=b.data.wid;var g={func_name:"WebTagType::delete",arg:d};b.post(g,function(h){console.log(h)})};a.addWebTagType=function(d,e){if(e.indexOf(d.tid)==-1){e.push(d.tid)}d.wid=b.data.wid;d.sort_id=e.length;var f={func_name:"WebTagType::insert",arg:d};b.post(f,function(g){console.log(g)})};a.$ctrl.$onInit=function(){a.tagSystem=b.data;a.tagType=c.data}}]});angular.module("tagSystem").component("searchTagElement",{bindings:{data:"="},templateUrl:"app/modules/tagSystem/components/searchTagElement/searchTagElement.html?t="+Date.now(),controller:["$scope","tagSystem","$timeout",function(b,c,d){b.addSearch=function(h,g){c.searchTid(h,function(i){c.addSearchTid(i,type)})};var f;var e=function(g){d.cancel(f);f=d(function(){c.getTagName(b.$ctrl.data.required);c.getTagName(b.$ctrl.data.optional);c.getTagName(b.$ctrl.data.tmp);var i=angular.copy(b.$ctrl.data.required);var h=angular.copy(b.$ctrl.data.optional);if(i.length+h.length){a(1,h,[],function(j){if(i.length){a(0,i,[],function(k){if(j.length){var m=[];for(var l in k){if(j.indexOf(k[l])!=-1){m.push(k[l])}}b.$ctrl.data.result=m}else{b.$ctrl.data.result=k}})}else{b.$ctrl.data.result=j}})}else{b.$ctrl.data.result=[]}},50)};b.$watch("$ctrl.data.required",e,1);b.$watch("$ctrl.data.optional",e,1);b.tagName=c.data.tagName;var a=function(h,n,l,o){if(!l){l=[]}var k=n.pop();var j=[];j.push({field:"wid",type:0,value:c.data.wid});j.push({field:"tid",type:0,value:k});for(var g in l){j.push({field:"source_id",type:h,value:l[g]})}var m={func_name:"WebRelation::getList",arg:{where_list:j,group_list:["source_id"]}};c.post(m,function(p){if(p.status){var i=p.list.map(function(q){return q.source_id});if(h==0){l=i}else{if(h==1){l=l.concat(i)}}}else{if(h==0){o([]);return}}if(n.length){a(h,n,l,o)}else{o(l)}})}}]});angular.module("tagSystem").factory("tagLevel",["$rootScope","tagSystem","$timeout","tagType",function(a,b,c,d){var e={tagTypeLevel:{},selects:{}};var f=function(l){var j=[];for(var g in l){var h=l[g];if(!e.tagTypeLevel[h]){e.tagTypeLevel[h]=[];e.selects[h]=[];j.push({field:"tid",type:0,value:h})}}if(!j.length){return}var k={func_name:"TagLevel::getList",arg:{where_list:j}};b.post(k,function(n){if(n.status){var p=n.list.sort(function(s,i){return s.sort_id-i.sort_id});for(var m in p){var o=p[m];var q=o.tid;var r=o.id;e.tagTypeLevel[q].push(r)}}})};a.$watch(function(){return d.data.select_arr},function(g){f(g)},1);return{data:e}}]);angular.module("tagSystem").factory("tagRelation",["$rootScope","tagSystem","$timeout","tagType","tagLevel",function(g,i,b,h,c){var e={TagLevelRelation:{}};var k=function(q,r,m,o){if(m.length==o.length){for(var n in m){if(m[n]!=o[n]){var p={func_name:"TagRelation::update",arg:{update:{sort_id:n},where:{level_id:q,id:r,child_id:m[n]}}};i.post(p,function(s){console.log(s)})}}}};var l=function(n){var o=[];for(var m in n){var q=n[m];if(!e.TagLevelRelation[q]){e.TagLevelRelation[q]={};o.push({field:"level_id",type:0,value:q})}}if(!o.length){return}var p={func_name:"TagRelation::getList",arg:{where_list:o,order_list:[{field:"sort_id",type:0}]}};i.post(p,function(s){if(s.status){var v=[];for(var r in s.list){var t=s.list[r];var x=t.id;var w=t.child_id;var u=t.level_id;if(!e.TagLevelRelation[u][x]){e.TagLevelRelation[u][x]=[]}e.TagLevelRelation[u][x].push(w);v.push(w)}i.getTagName(v);for(var u in e.TagLevelRelation){for(var x in e.TagLevelRelation[u]){g.$watch(function(y,z){return e.TagLevelRelation[y][z]}.bind(this,u,x),k.bind(this,u,x),1)}d(u)}}})};g.$watch(function(){return c.data.tagTypeLevel},function(m){var n=[];for(var o in m){n=n.concat(m[o])}if(n.length){l(n)}},1);var d=function(r){for(var q in c.data.tagTypeLevel){var p=c.data.tagTypeLevel[q];if(p[0]==r){var o,m;for(var n in p){var r=p[n];if(n==0){m=0}else{if(o){m=o[0]}else{continue}}c.data.selects[q][n]=m;o=e.TagLevelRelation[r][m]}if(o&&o[0]){c.data.selects[q][n*1+1]=o[0]}break}else{}}};var a=function(o,n){for(var p in o){var m=o[p];if(n.indexOf(m)==-1){return m}}};var j=function(m){f[m]=g.$watch(function(n){return c.data.selects[n]}.bind(this,m),function(t,p,q){var s=c.data.tagTypeLevel[t];if(p.length==q.length){for(var o in p){if(p[o]!=q[o]){var n=p[o];if(p[o*1+1]){var u=s[o];var r=e.TagLevelRelation[u][n];if(r&&r[0]){p[o*1+1]=r[0]}else{p[o*1+1]=null}}}}}}.bind(this,m),1)};var f={};g.$watch(function(){return h.data.select_arr},function(q,p){var n=q.length-p.length;if(n>0){var o=a(q,p);j(o)}else{if(n<0){var o=a(p,q);f[o]&&f[o]()}else{for(var m in q){var o=q[m];if(!f[o]){j(o)}}}}},1);return{data:e}}]);angular.module("tagSystem").factory("tagSystem",["$rootScope",function(k){var f={tagName:{},control:{mode:0,edit:{},search:{}},sourceIdRelationTag:{},selects:[],tag_mode:0};var e=document.createElement("iframe");e.style="width:100%;height:100%;";e.setAttribute("marginwidth",0);e.setAttribute("marginheight",0);e.setAttribute("scrolling","no");e.setAttribute("frameborder",0);e.setAttribute("style","display:none;");var b;var d={};var g={};var n=function(p){var o=function(){b=e.contentWindow;postMessageHelper.init("tagSystem",b);postMessageHelper.receive("tagSystem",function(q){if(q.name=="post"){g[q.value.id]=q.value.value}k.$apply()})};e.onload=o;e.src=p};var l=function(o,r){var q="rand"+Date.now()+Math.floor(Math.random()*9999);postMessageHelper.send("tagSystem",{name:"post",value:{request:o,id:q}});var p=k.$watch(function(s){return g[s]}.bind(this,q),function(s){if(s){r&&r(s);p()}},1)};var m=function(r){var p=[];for(var o in r){if(!f.tagName[r[o]]){p.push({field:"id",type:0,value:r[o]})}}if(!p.length){return}var q={func_name:"TagName::getList",arg:{where_list:p}};l(q,function(u){if(u.status){for(var t in u.list){var v=u.list[t].id;var s=u.list[t].name;f.tagName[v]=s}}})};var c={};var a=function(o,p){if(o.tid){p.push(o.tid)}else{if(!o.tag_name){alert("請勿空白");return}}if(c[o.source_id]){alert("新增資料中，請稍等...");return}else{c[o.source_id]=true}o.wid=f.wid;o.sort_id=p.length;var q={func_name:"WebRelation::insert",arg:o};l(q,function(r){if(o.tag_name){if(r.status){var s=r.insert.tid;f.tagName[s]=o.tag_name;p.push(s);alert("新增成功")}else{alert("新增失敗")}}delete c[o.source_id]})};var j=function(q,o,t){if(!confirm("確認刪除?")){return}var r=q.splice(o,1).pop();var p=f.wid;var s={func_name:"WebRelation::delete",arg:{source_id:t,wid:p,tid:r}};l(s,function(u){console.log(u);if(!u.status){q.splice(o,0,r)}})};var h=function(s,r){var p=["optional","required","tmp"];for(var q in p){var o=f.control.search.data[p[q]].indexOf(s);if(o==-1){}else{f.control.search.data[p[q]].splice(o,1)}}f.control.search.data[p[r]].push(s)};var i=function(q,r){var o=[];o.push({field:"name",type:0,value:q});var p={func_name:"TagName::getList",arg:{where_list:o}};l(p,function(t){if(t.status){var u=t.list[0].id;var s=t.list[0].name;f.tagName[u]=s;r&&r(u)}else{alert("沒有這個標籤")}})};return{init:n,iframe:e,post:l,data:f,getTagName:m,delTag:j,addTag:a,searchTid:i,addSearchTid:h}}]);angular.module("tagSystem").factory("tagType",["$rootScope","tagSystem","$timeout",function(b,c,d){var f={select_arr:[],not_select_arr:[],primary_data:{}};var a=function(){return new Promise(function(j,i){var k={func_name:"WebTagType::getList",arg:{where_list:[{field:"wid",type:0,value:c.data.wid}],order_list:[{field:"sort_id",type:0}]}};c.post(k,function(l){if(l.status){f.select_arr=l.list.map(function(m){return m.tid})}j()})})};var e=function(){return new Promise(function(j,i){var k=[];var l={func_name:"TagType::getList",arg:{where_list:k}};c.post(l,function(n){if(n.status){for(var m in n.list){var o=n.list[m];var p=o.id;f.primary_data[p]=o}}j()})})};var h;var g=function(){d.cancel(h);h=d(function(){f.not_select_arr=[];for(var j in f.primary_data){j*=1;var i=f.select_arr.indexOf(j);if(i==-1){f.not_select_arr.push(j)}}},0)};e().then(function(){return a()}).then(function(){b.$watch(function(){return f.primary_data},g,1);b.$watch(function(){return f.select_arr},g,1);b.$watch(function(){return f.select_arr},function(j,l){if(j.length==l.length){for(var k in j){if(j[k]!=l[k]){var m={func_name:"WebTagType::update",arg:{where:{wid:c.data.wid,tid:j[k]},update:{sort_id:k}}};c.post(m,function(i){console.log(i)})}}}},1)});return{data:f}}]);
